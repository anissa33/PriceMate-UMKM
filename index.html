<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PriceMate UMKM - Hitung Harga Jual Mudah</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome untuk Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2E7D32; /* Hijau Tua */
            --primary-light: #4CAF50; /* Hijau Terang */
            --secondary-color: #FFFFFF;
            --bg-color: #F5F5F5;
            --accent-color: #FBC02D; /* Kuning */
            --text-main: #333333;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
        }

        /* Utility Classes */
        .text-primary-custom { color: var(--primary-color); }
        .bg-primary-custom { background-color: var(--primary-color) !important; color: white; }
        .btn-primary-custom {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transition: all 0.3s;
        }
        .btn-primary-custom:hover {
            background-color: #1b5e20;
            border-color: #1b5e20;
            color: white;
            transform: translateY(-2px);
        }
        .btn-accent {
            background-color: var(--accent-color);
            color: #333;
            font-weight: 600;
            border: none;
        }
        .btn-accent:hover {
            background-color: #f9a825;
            color: #333;
        }

        /* Auth Container */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2E7D32 0%, #81c784 100%);
        }

        .auth-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
            max-width: 450px;
            padding: 2rem;
            position: relative;
        }

        /* Dashboard Styling */
        .navbar-custom {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
            font-size: 1.5rem;
        }

        .card-custom {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s;
            background: white;
            height: 100%;
        }

        .card-custom:hover {
            transform: translateY(-3px);
        }

        .card-header-custom {
            background-color: transparent;
            border-bottom: 2px solid #f0f0f0;
            padding: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .result-box {
            background-color: #e8f5e9;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            margin-top: 1rem;
            border: 1px solid #c8e6c9;
        }

        .price-display {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(46, 125, 50, 0.25);
        }

        /* Table Styling */
        .table-custom thead {
            background-color: var(--primary-color);
            color: white;
        }
        
        .table-custom th {
            border: none;
        }
        
        .table-hover tbody tr:hover {
            background-color: #f1f8e9;
        }

        /* Animation Classes */
        .fade-in {
            opacity: 0;
        }
        
        .hidden {
            display: none !important;
        }

        /* Alert styling */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
</head>
<body>

    <!-- Toast Notification -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ================= AUTH SECTION ================= -->
    <div id="authSection" class="auth-container">
        
        <!-- LOGIN FORM -->
        <div id="loginForm" class="auth-card fade-in">
            <div class="text-center mb-4">
                <i class="fas fa-calculator fa-3x text-primary-custom mb-2"></i>
                <h3 class="fw-bold text-primary-custom">PriceMate UMKM</h3>
                <p class="text-muted small">Masuk untuk mulai menghitung keuntungan</p>
            </div>
            
            <form onsubmit="handleLogin(event)">
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                        <input type="email" class="form-control" id="loginEmail" placeholder="nama@email.com" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                        <input type="password" class="form-control" id="loginPassword" placeholder="******" required>
                    </div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="rememberMe">
                    <label class="form-check-label small" for="rememberMe">Ingat Saya</label>
                </div>
                <button type="submit" class="btn btn-primary-custom w-100 py-2 fw-bold">Masuk</button>
            </form>
            
            <div class="text-center mt-4 pt-3 border-top">
                <p class="small mb-0">Belum punya akun? <a href="#" onclick="switchAuth('register')" class="text-primary-custom fw-bold">Daftar Sekarang</a></p>
            </div>
        </div>

        <!-- REGISTER FORM -->
        <div id="registerForm" class="auth-card hidden fade-in">
            <div class="text-center mb-4">
                <h3 class="fw-bold text-primary-custom">Buat Akun Baru</h3>
                <p class="text-muted small">Bergabunglah dengan komunitas UMKM pintar</p>
            </div>
            
            <form onsubmit="handleRegister(event)">
                <div class="mb-3">
                    <label class="form-label">Nama Lengkap</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                        <input type="text" class="form-control" id="regName" placeholder="Nama Anda" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                        <input type="email" class="form-control" id="regEmail" placeholder="nama@email.com" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                        <input type="password" class="form-control" id="regPassword" placeholder="Min. 6 karakter" minlength="6" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary-custom w-100 py-2 fw-bold">Daftar</button>
            </form>
            
            <div class="text-center mt-4 pt-3 border-top">
                <p class="small mb-0">Sudah punya akun? <a href="#" onclick="switchAuth('login')" class="text-primary-custom fw-bold">Masuk Disini</a></p>
            </div>
        </div>
    </div>

    <!-- ================= DASHBOARD SECTION ================= -->
    <div id="dashboardSection" class="hidden fade-in">
        
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-coins me-2 text-warning"></i>PriceMate UMKM
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item me-3">
                            <span class="text-muted small">Halo, <strong id="userNameDisplay" class="text-dark">User</strong></span>
                        </li>
                        <li class="nav-item">
                            <button onclick="handleLogout()" class="btn btn-outline-danger btn-sm rounded-pill px-3">
                                <i class="fas fa-sign-out-alt me-1"></i> Keluar
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container py-5">
            <div class="row g-4">
                
                <!-- Calculator Card -->
                <div class="col-lg-7">
                    <div class="card card-custom">
                        <div class="card-header-custom d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-calculator me-2"></i>Kalkulator Harga</span>
                            <button onclick="resetForm()" class="btn btn-sm btn-outline-secondary" title="Reset Form"><i class="fas fa-redo"></i> Reset</button>
                        </div>
                        <div class="card-body p-4">
                            <form id="calcForm" onsubmit="calculatePrice(event)">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Modal Bahan Baku (Total)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Rp</span>
                                            <input type="number" class="form-control" id="inputModal" placeholder="0" min="0" required>
                                        </div>
                                        <div class="form-text small">Biaya beli bahan untuk satu batch produksi.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Biaya Operasional</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Rp</span>
                                            <input type="number" class="form-control" id="inputOperasional" placeholder="0" min="0" required>
                                        </div>
                                        <div class="form-text small">Listrik, gas, tenaga kerja, kemasan, dll.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Jumlah Produk</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-box"></i></span>
                                            <input type="number" class="form-control" id="inputJumlah" placeholder="0" min="1" required>
                                        </div>
                                        <div class="form-text small">Hasil produk dari modal di atas (pcs/porsi).</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Target Keuntungan</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="inputMargin" placeholder="30" min="0" required>
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <div class="form-text small">Persentase keuntungan yang diinginkan.</div>
                                    </div>
                                </div>
                                <div class="d-grid mt-4">
                                    <button type="submit" class="btn btn-primary-custom py-2 fw-bold">
                                        <i class="fas fa-paper-plane me-2"></i>Hitung Harga Jual
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Result Card -->
                <div class="col-lg-5">
                    <div class="card card-custom bg-white" id="resultCard" style="opacity: 0.8;">
                        <div class="card-header-custom border-bottom-0">
                            <span><i class="fas fa-chart-line me-2"></i>Hasil Perhitungan</span>
                        </div>
                        <div class="card-body p-4 text-center d-flex flex-column justify-content-center h-100">
                            
                            <div id="emptyState">
                                <img src="https://cdn-icons-png.flaticon.com/512/2921/2921226.png" alt="Calculator" width="100" class="mb-3 opacity-50">
                                <p class="text-muted">Masukkan data di sebelah kiri untuk melihat rekomendasi harga.</p>
                            </div>

                            <div id="resultContent" class="hidden">
                                <h6 class="text-muted text-uppercase fw-bold mb-1">Rekomendasi Harga Jual / Unit</h6>
                                <div class="price-display mb-3">Rp <span id="resHargaJual">0</span></div>
                                
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <div class="p-2 border rounded bg-light">
                                            <small class="d-block text-muted">HPP (Modal) / Unit</small>
                                            <span class="fw-bold">Rp <span id="resHPP">0</span></span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 border rounded bg-light">
                                            <small class="d-block text-muted">Untung / Unit</small>
                                            <span class="fw-bold text-success">Rp <span id="resProfit">0</span></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning py-2 mb-3 small">
                                    <i class="fas fa-info-circle me-1"></i> Harga ini sudah termasuk margin <span id="resMarginText">0</span>%
                                </div>

                                <button onclick="saveCalculation()" class="btn btn-accent w-100">
                                    <i class="fas fa-save me-2"></i>Simpan ke Riwayat
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card card-custom">
                        <div class="card-header-custom d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-history me-2"></i>Riwayat Perhitungan</span>
                            <button onclick="clearHistory()" class="btn btn-sm btn-outline-danger">Hapus Semua</button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-custom mb-0 align-middle">
                                    <thead>
                                        <tr>
                                            <th class="ps-4">Tanggal</th>
                                            <th>Produk</th>
                                            <th>Modal Total</th>
                                            <th>HPP/Unit</th>
                                            <th>Harga Jual</th>
                                            <th>Profit</th>
                                            <th class="text-end pe-4">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historyTableBody">
                                        <!-- Data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="noHistory" class="text-center py-5 hidden">
                                <p class="text-muted mb-0">Belum ada riwayat perhitungan tersimpan.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        
        <footer class="bg-white py-4 mt-5 border-top">
            <div class="container text-center">
                <p class="text-muted mb-0 small">&copy; 2026 PriceMate UMKM. Dibuat untuk kemajuan UMKM Indonesia.</p>
            </div>
        </footer>
    </div>

    <!-- Anime.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- 1. CONFIGURATION & STATE ---
        const USERS_KEY = 'umkm_users';
        const SESSION_KEY = 'umkm_session';
        let currentUser = null;
        let lastCalculation = null;

        // --- 2. AUTHENTICATION LOGIC ---

        function initApp() {
            checkSession();
            animateEntry();
        }

        function checkSession() {
            const session = JSON.parse(localStorage.getItem(SESSION_KEY));
            if (session) {
                // Validate if user still exists in DB
                const users = getUsers();
                const validUser = users.find(u => u.email === session.email);
                
                if (validUser) {
                    currentUser = validUser;
                    showDashboard();
                } else {
                    localStorage.removeItem(SESSION_KEY);
                    showAuth();
                }
            } else {
                showAuth();
            }
        }

        function getUsers() {
            return JSON.parse(localStorage.getItem(USERS_KEY)) || [];
        }

        function saveUsers(users) {
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
        }

        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            const users = getUsers();
            
            if (users.find(u => u.email === email)) {
                showToast('Email sudah terdaftar!', 'danger');
                return;
            }

            // Simple "Hash" for demo (Base64 + salt) - Not for real production banking!
            const hashedPassword = btoa(password + "umkm_salt");

            const newUser = {
                name: name,
                email: email,
                password: hashedPassword,
                history: []
            };

            users.push(newUser);
            saveUsers(users);
            
            showToast('Registrasi berhasil! Silakan login.', 'success');
            document.getElementById('regName').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
            switchAuth('login');
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('rememberMe').checked;

            const users = getUsers();
            const hashedPassword = btoa(password + "umkm_salt");
            const user = users.find(u => u.email === email && u.password === hashedPassword);

            if (user) {
                currentUser = user;
                if (remember) {
                    localStorage.setItem(SESSION_KEY, JSON.stringify({ email: user.email }));
                }
                showToast('Login berhasil! Selamat datang.', 'success');
                showDashboard();
            } else {
                showToast('Email atau password salah!', 'danger');
                anime({
                    targets: '#loginForm',
                    translateX: [0, -10, 10, -10, 10, 0],
                    duration: 500
                });
            }
        }

        function handleLogout() {
            localStorage.removeItem(SESSION_KEY);
            currentUser = null;
            location.reload(); // Refresh to clean state
        }

        // --- 3. UI MANAGEMENT ---

        function switchAuth(type) {
            if (type === 'register') {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
                anime({
                    targets: '#registerForm',
                    opacity: [0, 1],
                    translateY: [20, 0],
                    duration: 600,
                    easing: 'easeOutExpo'
                });
            } else {
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
                anime({
                    targets: '#loginForm',
                    opacity: [0, 1],
                    translateY: [20, 0],
                    duration: 600,
                    easing: 'easeOutExpo'
                });
            }
        }

        function showAuth() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            
            renderHistory();
            
            // Animate Dashboard Entry
            anime({
                targets: '#dashboardSection',
                opacity: [0, 1],
                duration: 800,
                easing: 'easeInOutQuad'
            });
            
            // Stagger animations for cards
            anime({
                targets: '.card-custom',
                translateY: [50, 0],
                opacity: [0, 1],
                delay: anime.stagger(150),
                easing: 'easeOutExpo'
            });
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast' + Date.now();
            
            const colorClass = type === 'success' ? 'text-bg-success' : 'text-bg-danger';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            const html = `
                <div id="${toastId}" class="toast align-items-center ${colorClass} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas ${icon} me-2"></i> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', html);
            const toastEl = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
            
            toastEl.addEventListener('hidden.bs.toast', () => {
                toastEl.remove();
            });
        }

        // --- 4. CALCULATOR LOGIC ---

        function formatCurrency(num) {
            return new Intl.NumberFormat('id-ID').format(Math.ceil(num));
        }

        function calculatePrice(e) {
            e.preventDefault();
            
            // Get Values
            const modal = parseFloat(document.getElementById('inputModal').value) || 0;
            const operasional = parseFloat(document.getElementById('inputOperasional').value) || 0;
            const jumlah = parseFloat(document.getElementById('inputJumlah').value) || 1;
            const marginPersen = parseFloat(document.getElementById('inputMargin').value) || 0;

            // Math
            const totalBiaya = modal + operasional;
            const hppPerUnit = totalBiaya / jumlah;
            const marginNominal = hppPerUnit * (marginPersen / 100);
            const hargaJual = hppPerUnit + marginNominal;
            
            // Store temp result
            lastCalculation = {
                id: Date.now(),
                date: new Date().toLocaleDateString('id-ID'),
                modalTotal: totalBiaya,
                qty: jumlah,
                hpp: hppPerUnit,
                margin: marginPersen,
                profitUnit: marginNominal,
                sellingPrice: hargaJual
            };

            // Display Results
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultContent').classList.remove('hidden');
            
            // Animate Numbers
            const counter = {
                valHPP: 0,
                valProfit: 0,
                valJual: 0
            };

            anime({
                targets: counter,
                valHPP: hppPerUnit,
                valProfit: marginNominal,
                valJual: hargaJual,
                easing: 'easeOutExpo',
                round: 1, // No decimal for display during animation
                duration: 1500,
                update: function() {
                    document.getElementById('resHPP').textContent = formatCurrency(counter.valHPP);
                    document.getElementById('resProfit').textContent = formatCurrency(counter.valProfit);
                    document.getElementById('resHargaJual').textContent = formatCurrency(counter.valJual);
                }
            });

            document.getElementById('resMarginText').textContent = marginPersen;

            // Highlight Result Card
            document.getElementById('resultCard').style.opacity = '1';
            document.getElementById('resultCard').classList.add('border-success');
            setTimeout(() => {
                document.getElementById('resultCard').classList.remove('border-success');
            }, 2000);
        }

        function resetForm() {
            document.getElementById('calcForm').reset();
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('resultContent').classList.add('hidden');
            document.getElementById('resultCard').style.opacity = '0.8';
            lastCalculation = null;
        }

        // --- 5. HISTORY MANAGEMENT ---

        function saveCalculation() {
            if (!lastCalculation || !currentUser) return;

            // Add to current user history
            currentUser.history.unshift(lastCalculation); // Add to top
            
            // Update LocalStorage
            const users = getUsers();
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                saveUsers(users);
                showToast('Perhitungan disimpan!', 'success');
                renderHistory();
            }
        }

        function renderHistory() {
            const tbody = document.getElementById('historyTableBody');
            const noHistory = document.getElementById('noHistory');
            
            tbody.innerHTML = '';
            
            if (!currentUser.history || currentUser.history.length === 0) {
                noHistory.classList.remove('hidden');
                return;
            } else {
                noHistory.classList.add('hidden');
            }

            currentUser.history.forEach((item) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="ps-4 small text-muted">${item.date}</td>
                    <td><span class="badge bg-secondary">${item.qty} pcs</span></td>
                    <td>Rp ${formatCurrency(item.modalTotal)}</td>
                    <td>Rp ${formatCurrency(item.hpp)}</td>
                    <td class="fw-bold text-primary">Rp ${formatCurrency(item.sellingPrice)}</td>
                    <td class="text-success small">+Rp ${formatCurrency(item.profitUnit)}</td>
                    <td class="text-end pe-4">
                        <button onclick="loadSimulation(${item.id})" class="btn btn-sm btn-outline-primary me-1" title="Simulasi Ulang"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteHistory(${item.id})" class="btn btn-sm btn-outline-danger" title="Hapus"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function deleteHistory(id) {
            currentUser.history = currentUser.history.filter(item => item.id !== id);
            
            // Update Storage
            const users = getUsers();
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                saveUsers(users);
                renderHistory();
                showToast('Riwayat dihapus.', 'success');
            }
        }

        function clearHistory() {
            if(confirm('Yakin ingin menghapus semua riwayat?')) {
                currentUser.history = [];
                const users = getUsers();
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    saveUsers(users);
                    renderHistory();
                }
            }
        }

        function loadSimulation(id) {
            const item = currentUser.history.find(i => i.id === id);
            if(item) {
                // Approximate reverse engineering for form fill (Simplification)
                // Assuming Operasional is 0 for simplicity or splitting ratio logic could be added
                // Here we just set total to modal input for recalculation ease
                document.getElementById('inputModal').value = item.modalTotal;
                document.getElementById('inputOperasional').value = 0; 
                document.getElementById('inputJumlah').value = item.qty;
                document.getElementById('inputMargin').value = item.margin;
                
                // Scroll to top
                document.querySelector('.navbar').scrollIntoView({behavior: 'smooth'});
                showToast('Data dimuat ulang. Silakan sesuaikan.', 'info');
                
                // Trigger animation on form
                anime({
                    targets: '#calcForm',
                    scale: [1, 1.02, 1],
                    duration: 400,
                    easing: 'easeOutQuad'
                });
            }
        }

        function animateEntry() {
            anime({
                targets: '.auth-card',
                translateY: [50, 0],
                opacity: [0, 1],
                duration: 1000,
                easing: 'easeOutExpo'
            });
        }

        // --- 6. INITIALIZATION ---
        window.onload = initApp;

    </script>
</body>
</html>